# nix-direnv race condition 주의사항
# ====================================
#
# `use flake` 실행 시 nix-direnv는 flake.nix/flake.lock의 타임스탬프를
# .direnv/ 캐시와 비교하여, 더 새로우면 캐시를 무효화하고 `nix print-dev-env`를
# 다시 실행한다. 이 재평가 과정에서 다음 두 가지 경합이 발생할 수 있다:
#
# 1) nixpkgs 소스 re-fetch로 인한 장시간 블로킹
#    - .direnv/flake-inputs/의 GC root 심링크가 stale 상태이면
#      `nix store gc`가 nixpkgs 소스를 수집해버린다.
#    - 캐시 무효화 시 nix가 nixpkgs를 처음부터 다시 fetch/copy하며,
#      이 과정에서 "is taking a while to execute" 경고가 표시된다.
#
# 2) eval cache SQLite 동시 접근 충돌
#    - 여러 터미널/IDE(Cursor 등)가 동시에 이 디렉토리에 진입하면
#      각각 독립적으로 direnv → nix print-dev-env를 실행한다.
#    - 이때 ~/.cache/nix/eval-cache-v6/*.sqlite에 동시 쓰기가 발생하여
#      "SQLite database is busy" 에러가 나타난다.
#    - 이 에러는 nix가 (ignored)로 처리하므로 최종 결과에는 영향 없지만,
#      평가 시간이 더 길어질 수 있다.
#
# 재현 조건:
#   - git checkout/pull/rebase 등으로 flake.nix 또는 flake.lock 타임스탬프 갱신
#   - 이후 여러 셸 세션이 거의 동시에 이 디렉토리에 진입
#
# 알려진 완화 방법 (각각 트레이드오프 있음, 현재 미적용):
#   - nix_direnv_manual_reload: 수동 reload 전용 → flake 변경 후 잊기 쉬움
#   - keep-derivations/keep-outputs: GC 후 re-fetch 방지 → 디스크 사용량 증가
#   - IDE 터미널 direnv 비활성화: 경합 제거 → IDE에서 devShell 환경 사용 불가
use flake
